{% extends 'bibtex/base.html' %}
{% load staticfiles %}
{% block content %}

<script src="{% static 'lib/jquery.form.min.js' %}"></script>

<script>

if(!String.prototype.startsWith){
	String.prototype.startsWith = function (str) {
		return !this.indexOf(str);
	}
}

function validate(text, responseText, statusText, xhr, $form) {
	{% if not entry %}
	var msgtext = "Paper sucessfully added to the database";
	{% else %}
	var msgtext = "Entry sucessfully edited";
	{% endif %}

	if(text.startsWith("BADFILE")) {
		swal({	title: "Warning", 
				text: "Your bibtex was accepted, but an error occurred trying to upload your file. Try editing your newly-added paper to add the file separately.", 
				type: "warning", confirmButtonText: "OK" }, 
				function() { window.location = "{% url 'bibtex:index' %}"; }
			);
	} else if(text.startsWith("OK")) {
		swal({	title: "Success", 
				text: msgtext, 
				type: "success", confirmButtonText: "OK" }, 
				function() { window.location = "{% url 'bibtex:index' %}"; }
			);
	} else swal({title: "Error!", text: text, type: "error", confirmButtonText: "OK" });
}

function filevalidate(text, responseText, statusText, xhr, $form) {
	if(text.startsWith("OK")) {
		swal({	title: "Success", 
				text: "File uploaded.", 
				type: "success", confirmButtonText: "OK" }, 
				function() { window.location = "{% url 'bibtex:index' %}"; }
			);
	} else swal({title: "Error!", text: text, type: "error", confirmButtonText: "OK" });
}

function deleteResponse(data) {
	if(data == "OK") {
		{% if entry %}
			window.location = "{% url 'bibtex:edit' entry.pk %}";
		{% else %}
			window.location = "{% url 'bibtex:index' %}";
		{% endif %}
	} else {
		swal({title: "Error!", text: data, type: "error", confirmButtonText: "OK" });		
	}
}

function checkfiles(data, jqForm, options) {
	for(var i = 0; i < data.length; i++) {
		if(data[i].name == "file" && data[i].value == "") {
			swal({title: "Error!", text: "Please select a file to upload.", type: "error", confirmButtonText: "OK" });
			return false;
		}
	}
	return true;
}

$(function() {
	$("#bibtexaddform").ajaxForm({success: validate});
	$("#fileaddform").ajaxForm({beforeSubmit: checkfiles, success: filevalidate});

	$(".deletefile").each(function(index) {
		$(this).click(function() {
			var delurl = $(this).data("id");
			swal({
				title: "Confirm delete",
				text: "Are you sure you want to delete this file?",
				type: "warning",
				showCancelButton: true,
				confirmButtonColor: "#DD6B55",
				confirmButtonText: "Delete"}, function() {
					$.ajax({
						type: "POST",
						url: delurl,
						data: {csrfmiddlewaretoken: "{{ csrf_token }}"},
						success: deleteResponse
					})
				});
		})
	});
	
})
</script>


{% if username %}

{% if not entry %}
<h1>Add an entry to the database</h1>

<p>You are adding as the user <span class="username">{{username}}</span>. In order to edit this entry in the future you will have to use the same user account. If this is incorrect, please log out and log in as a different user.</p>
{% else %}
<h1>Edit an entry</h1>
{% endif %}

<div class="editbox">
<p class="notopmargin">Please ensure that your Bibtex has <tt>title</tt>, <tt>author</tt> and <tt>year</tt> fields, and you should include an <tt>abstract</tt> field if possible.</p>

<form action="{%url 'bibtex:validate' %}" method="post" id="bibtexaddform" enctype="multipart/form-data">
	{% csrf_token %}
	{% if entry %}
	<input type="hidden" name="pk" value={{entry.pk}}>
	<input type="hidden" name="edit" value="edit">
	{% endif %}
	<div>
		<div><label for="bibtex">Raw bibtex input:</label></div>
		<textarea cols="60" rows="15" name="bib">{{entry.bib}}</textarea>
	</div><p></p>

	<div>
	{% if entry %}
		{# Allow file deletions if at least one DocEntry exists for this Entry #}
		{% if docfile_set|length > 0 %}
			<h3>Files linked to this entry</h3>
			<ul class="filelist">
			{% for doc in docfile_set %}
				<li><a href="{{ftpbase}}{{doc.filename}}">{{doc.filename}}</a> - <a href="#"><span class="deletefile" data-id="{%url 'bibtex:delete_file' doc.id %}">Delete</span></a></li>
			{% endfor %}
			</ul>
		{% endif %}
	{% else %}
		{# Can upload a file along with a new entry #}
		<div><label for="file">Upload file</label></div>
		<input type="file" name="file">

		<p><div><input type="checkbox" name="email" value="email" checked>
		Email the RTS group that this paper has been submitted?</div>

	{% endif %}

	</div>

	<div class="centre">
		<input type="submit" class="submit" value="Submit">
	</div>
</form>
</div>

{% if entry %}
{# Couldn't nest the file upload form, so if in edit mode we create a new one here. #}
<div class="editbox">
<div><h3 class="notopmargin">Upload new file for this entry</h3></div><p></p>
<form action="{%url 'bibtex:add_file' entry.pk %}" method="post" id="fileaddform" enctype="multipart/form-data">
{% csrf_token %}
<input type="hidden" name="pk" value={{entry.pk}}>
<input type="file" name="file"><br>
<div class="centre">
	<input type="submit" class="submit" value="Upload">
</div>
</form>
</div>
{% endif %}


{% else %}

<h1>Not logged in</h1>
<p>You are not logged in to the departmental webpages.</p>
{% endif %}

<p><a href="{% url 'bibtex:index' %}">Back</a></p>

{% endblock %}
